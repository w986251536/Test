package com.chinasofti.blc.tiremusic.user.usercontorller;

import java.io.IOException;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.Cookie;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import com.chinasofti.blc.tiremusic.common.controller.BaseController;
import com.chinasofti.blc.tiremusic.user.userservice.UserLoginService;
@WebServlet("/user/*")
public class UserLoginContorller extends BaseController{
	
	private static final long serialVersionUID = 1L;
	/**
	 * 用户登录
	 */
	public void userLoginContorller(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
		UserLoginService userloginservice = new UserLoginService();
		
		String condition = req.getParameter("condition");
		//登录成功sesseion中保存的uid
		req.getSession().setAttribute("uid",userloginservice.queryAll().getUid());
		String password = req.getParameter("upassword");
		String remFlag = req.getParameter("remFlag");
		if("1".equals(remFlag)){ //"1"表示用户勾选记住密码
			Cookie usernameCookie = new Cookie("uname",condition);
			usernameCookie.setPath("/tiremusic");
			usernameCookie.setMaxAge(30);
			Cookie passwordCookie = new Cookie("password", password);
			passwordCookie.setPath("/tiremusic");
			usernameCookie.setMaxAge(30);
			resp.addCookie(usernameCookie);
			resp.addCookie(passwordCookie);
        }
		boolean flag1=false;
		req.getSession().setAttribute("user", userloginservice.queryAll());
		//根据用户输入的邮箱或者地址或手机号码登录
		if(userloginservice.userLoginByUtelephone(condition, password)!=null) {
			flag1 = condition.equals(userloginservice.userLoginByUtelephone(condition, password).getUtelephone())&&password.equals(userloginservice.userLoginByUtelephone(condition, password).getUpassword());
		}
		boolean flag2 = false;
		if(userloginservice.userLoginByUemail(condition, password)!=null) {
			flag2 = condition.equals(userloginservice.userLoginByUemail(condition, password).getUemail())&&password.equals(userloginservice.userLoginByUemail(condition, password).getUpassword());
		}
		boolean flag3 = false;
		if(userloginservice.userLoginByUname(condition, password)!=null) {
			flag3 = condition.equals(userloginservice.userLoginByUname(condition, password).getUname())&&password.equals(userloginservice.userLoginByUname(condition, password).getUpassword());
		}
		if(flag1||flag2||flag3) {
			req.getRequestDispatcher("/chahua/index.jsp").forward(req, resp);
		}
		else {
			req.setAttribute("logininfo", "用户名或密码错误！");
			req.getRequestDispatcher("/chahua/signin.jsp").forward(req, resp);
		}
	}
}
